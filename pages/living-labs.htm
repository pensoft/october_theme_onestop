url = "/living-labs"
layout = "default"
title = "Living Labs"
is_hidden = 0
meta_description = "living labs page"
seo_keywords = "keywords"
robot_index = "index"
robot_follow = "follow"

[jumbotron living-labs-intro]
jumbotron = "living-labs-intro"
templates = "template2" 
description_limit = 0

[jumbotron living-labs-outro]
jumbotron = "living-labs-outro"
templates = "template2" 
description_limit = 0

[siteSearchInclude]

==
<?php
use Pensoft\Partners\Models\Partners as Partner;
use RainLab\Location\Models\Country;
use Pensoft\Articles\Models\Article;

function onStart(){
    $this['living_labs'] = Partner::where('type', 2)->get();
    
    // Country name mapping
    $countryNames = [
        'RO' => 'Romania',
        'FI' => 'Finland',
        'BE' => 'Belgium', 
        'PT' => 'Portugal',
        'GB' => 'United Kingdom'
    ];
    
    // City name mapping for living labs
    $cityNames = [
        'RO' => 'Constanta',
        'FI' => 'Uusimaa',
        'BE' => 'Brussels',
        'PT' => 'Porto',
        'GB' => 'Coventry'
    ];
    
    // Get country names from database if available
    if (class_exists('RainLab\Location\Models\Country')) {
        $countries = Country::whereIn('code', array_keys($countryNames))->get();
        foreach ($countries as $country) {
            $countryNames[$country->code] = $country->name;
        }
    }
    
    // Prepare enhanced partner data for JavaScript
    $partnersData = [];
    foreach ($this['living_labs'] as $partner) {
        $countryCodes = is_array($partner->country_code) ? $partner->country_code : (json_decode($partner->country_code, true) ?: []);
        foreach ($countryCodes as $countryCode) {
            if (!isset($partnersData[$countryCode])) {
                $partnersData[$countryCode] = [
                    'countryName' => $countryNames[$countryCode] ?? $countryCode,
                    'partners' => []
                ];
            }
            $partnersData[$countryCode]['partners'][] = [
                'id' => $partner->id,
                'institution' => $partner->instituion,
                'description' => strip_tags($partner->content),
                'logo' => $partner->cover ? $partner->cover->getThumb(120, 80, 'auto') : null,
                'url' => $partner->instituion_url,
                'email' => $partner->email,
                'background' => $partner->background ? $partner->background->getPath() : null
            ];
        }
    }
    
    $this['partnersData'] = $partnersData;
    $this['countryNames'] = $countryNames;
    $this['cityNames'] = $cityNames;

    // Fetch related news articles with "living labs" keywords
    $this['related_articles'] = Article::news()
        ->where('published', true)
        ->where('published_at', '<=', now())
        ->where(function($q) {
            $q->whereRaw('LOWER(keywords) LIKE ?', ['%living lab%'])
              ->orWhereRaw('LOWER(keywords) LIKE ?', ['%living-lab%'])
              ->orWhereRaw('LOWER(keywords) LIKE ?', ['%livinglab%']);
        })
        ->orderBy('published_at', 'desc')
        ->limit(10)
        ->get();
}
?>
==

{% component 'siteSearchInclude' %}

<div class="container-fluid living-labs-page">
    <div class="container container-1600">
        <div class="row">
            <div class="col-md-6 col-xs-12 content">
                <div class="col-md-12">
                    {% component 'living-labs-intro' %}
                </div>
            </div>
            <div class="col-md-6 col-xs-12">
                <div class="map living-labs-map">
                    {% partial 'components/living-labs-map' %}
                    {% partial 'components/living-labs-popup' %}
                </div>
            </div>
        </div>
    </div>

    {% if related_articles|length > 0 %}
    {% if related_articles|length >= 4 %}
    <div class="container-fluid highlights-news related-news-carousel">
        <div class="container container-1600 news-header">
            <h2 class="display-1">Latest News</h2>
            <div class="news-arrows">
                <button type="button" class="trigger_prev_arrow" aria-label="Previous news"></button>
                <button type="button" class="trigger_next_arrow" aria-label="Next news"></button>
            </div>
        </div>
        <div class="container container-1600">
            <div class="news-carousel">
                {% for article in related_articles %}
                <div class="home-news-highlights">
                    <div class="row news-item">
                        <div class="col-md-12 col-xs-12 home-news-cover">
                            <a href="/news/{{ article.slug }}">
                                <img src="{{ article.cover.path }}" alt="{{ article.title }}">
                                <div class="btn read-more-btn btn-primary">Read more</div>
                            </a>
                        </div>
                        <div class="col-md-12 col-xs-12 news-content">
                            <div class="news-date">{{ article.published_at|date('d.m.Y') }}</div>
                            <a href="/news/{{ article.slug }}">
                                <div class="news-title">{{ article.title|length > 100 ? article.title|slice(0, 100) ~ '...' : article.title }}</div>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="container-fluid highlights-news related-news-static">
        <div class="container-1600">
            <h2 class="display-1">Latest News</h2>
        </div>
        <div class="container-1600">
            <div class="news-static-grid">
                {% for article in related_articles %}
                <div class="home-news-highlights">
                    <div class="row news-item">
                        <div class="col-md-12 col-xs-12 home-news-cover">
                            <a href="/news/{{ article.slug }}">
                                <img src="{{ article.cover.path }}" alt="{{ article.title }}">
                                <div class="btn read-more-btn btn-primary">Read more</div>
                            </a>
                        </div>
                        <div class="col-md-12 col-xs-12 news-content">
                            <div class="news-date">{{ article.published_at|date('d.m.Y') }}</div>
                            <a href="/news/{{ article.slug }}">
                                <div class="news-title">{{ article.title|length > 100 ? article.title|slice(0, 100) ~ '...' : article.title }}</div>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

<script>
// Theme URL for JavaScript asset paths
window.themeUrl = "{{ 'assets' | theme | replace({'assets': ''}) }}".slice(0, -1);
// Make enhanced partner data available to JavaScript
window.livingLabsPartners = {{ partnersData|json_encode|raw }};
window.countryNames = {{ countryNames|json_encode|raw }};
window.cityNames = {{ cityNames|json_encode|raw }};
</script>
